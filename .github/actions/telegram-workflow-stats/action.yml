# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è workflow.
# –°–µ–∫—Ä–µ—Ç—ã: TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID (Settings ‚Üí Secrets and variables ‚Üí Actions).

name: 'Telegram Workflow Stats'
description: 'Send workflow completion stats to Telegram bot'

inputs:
  workflow_name:
    description: '–ò–º—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (workflow)'
    required: true
  keys_in:
    description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ VPN-–∫–ª—é—á–µ–π –Ω–∞ –≤—Ö–æ–¥–µ'
    required: false
    default: ''
  keys_out:
    description: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –∫–ª—é—á–µ–π –Ω–∞ –≤—ã—Ö–æ–¥–µ'
    required: false
    default: ''
  duration:
    description: '–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (mm:ss), –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–º'
    required: false
    default: ''
  bot_token:
    description: 'Telegram Bot Token (–ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–∑ secrets.TELEGRAM_BOT_TOKEN)'
    required: false
    default: ''
  chat_id:
    description: 'Telegram Chat ID (–ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–∑ secrets.TELEGRAM_CHAT_ID)'
    required: false
    default: ''
  extra_section:
    description: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏¬ª —Å–æ —Å—Å—ã–ª–∫–∞–º–∏), –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Send stats to Telegram
      shell: bash
      run: |
        if [ -z "${{ inputs.bot_token }}" ] || [ -z "${{ inputs.chat_id }}" ]; then
          echo "TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set, skip sending"
          exit 0
        fi
        KEYS_IN="${{ inputs.keys_in }}"
        KEYS_OUT="${{ inputs.keys_out }}"
        [ -z "$KEYS_IN" ] && KEYS_IN="-"
        [ -z "$KEYS_OUT" ] && KEYS_OUT="-"
        STATS_LINE=""
        if [[ "$KEYS_IN" =~ ^[0-9]+$ ]] && [[ "$KEYS_OUT" =~ ^[0-9]+$ ]] && [ "$KEYS_IN" -gt 0 ]; then
          PCT=$(( KEYS_OUT * 100 / KEYS_IN ))
          STATS_LINE="–ö–æ–Ω—Ñ–∏–≥–æ–≤: $KEYS_IN ‚Üí $KEYS_OUT ($PCT%)"
        fi
        DURATION="${{ inputs.duration }}"
        DURATION_LINE=""
        [ -n "$DURATION" ] && DURATION_LINE="–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $DURATION"
        EXTRA="${{ inputs.extra_section }}"
        SEP="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        PAYLOAD=$(jq -n \
          --arg chat_id "${{ inputs.chat_id }}" \
          --arg workflow "${{ inputs.workflow_name }}" \
          --arg stats_line "$STATS_LINE" \
          --arg duration_line "$DURATION_LINE" \
          --arg extra "$EXTRA" \
          --arg sep "$SEP" \
          '{} | .chat_id = $chat_id | .parse_mode = "Markdown" | .text = (
            "‚úÖ *" + $workflow + "*"
            + (if $stats_line != "" then "\n\n`" + $stats_line + "`" else "" end)
            + (if $duration_line != "" then "\n\n`" + $duration_line + "`" else "" end)
            + "\n\n" + $sep
            + (if $extra != "" then "\n\nüìã " + $extra else "" end)
          ) | .reply_markup = {"inline_keyboard": [[{"text": "XRayCheck", "url": "https://whiteprime.github.io/xraycheck/"}]]}')
        curl -sS -X POST "https://api.telegram.org/bot${{ inputs.bot_token }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD"
