# Speedtest конфигов из configs/available и configs/white-list_available
# configs/available_st, configs/available_st(top100), configs/white-list_available_st, configs/white-list_available_st(top100).
# Запускается: после Daily DOCKER check, по расписанию каждые 30 мин (кроме ночного окна 21:30-00:30 UTC), вручную.
# Параметры speedtest - из .env (см. комментарии в шагах).

name: Speedtest

on:
  schedule:
    # Каждые 30 мин (UTC), кроме ночного окна для Actualize → Nightly → Update stats (21:30-00:30)
    - cron: '0 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21 * * *'
    - cron: '30 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21 * * *'
  workflow_run:
    workflows: ["Daily DOCKER check"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  MAX_WORKERS: 700
  BASE_PORT: 20000
  XRAY_STARTUP_WAIT: 2.2
  XRAY_STARTUP_POLL_INTERVAL: 0.2
  SPEED_TEST_ENABLED: 'true'
  SPEED_TEST_TIMEOUT: 5
  SPEED_TEST_MODE: full
  SPEED_TEST_METRIC: latency
  SPEED_TEST_OUTPUT: separate_file
  SPEED_TEST_REQUESTS: 10
  SPEED_TEST_URL: https://www.gstatic.com/generate_204
  SPEED_TEST_WORKERS: 700
  SPEED_TEST_DOWNLOAD_TIMEOUT: 25
  SPEED_TEST_DOWNLOAD_URL_SMALL: https://speed.cloudflare.com/__down?bytes=250000
  SPEED_TEST_DOWNLOAD_URL_MEDIUM: https://speed.cloudflare.com/__down?bytes=1000000
  MIN_SPEED_THRESHOLD_MBPS: 2.5
  SPEED_TEST_DEBUG: 'false'
  OUTPUT_DIR: configs
  VERIFY_HTTPS_SSL: 'false'

  # strip_vpn_comments.py: текст комментария (после флага страны) для проверенных конфигов
  AUTO_COMMENT: ' verified · t.me/XRayCheck'

concurrency:
  group: xraycheck-serial
  cancel-in-progress: false

jobs:
  speedtest-and-publish:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write
    outputs:
      stats_workflow_name: ${{ steps.telegram_stats.outputs.workflow_name }}
      stats_keys_in: ${{ steps.telegram_stats.outputs.keys_in }}
      stats_keys_out: ${{ steps.telegram_stats.outputs.keys_out }}
      stats_duration: ${{ steps.telegram_stats.outputs.duration }}
    env:
      XRAY_PATH: ${{ github.workspace }}/tools/xray
      HYSTERIA_PATH: ${{ github.workspace }}/tools/hysteria

    steps:
      - name: Record start time
        id: start
        run: echo "started_at=$(date -u +%s)" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Setup Xray and Hysteria binaries
        run: bash tools/setup-binaries.sh

      - name: Ensure configs/available and configs/white-list_available exist
        run: |
          for f in configs/available configs/white-list_available; do
            if [ ! -f "$f" ]; then
              echo "::error::$f not found. Run Daily VLESS check first."
              exit 1
            fi
            if [ ! -s "$f" ]; then
              echo "::error::$f is empty."
              exit 1
            fi
            echo "$f: $(wc -l < "$f") lines"
          done

      - name: "Split configs/available into Xray and Hysteria"
        run: |
          python - << 'PY'
          from pathlib import Path
          prefixes = ("hysteria://", "hysteria2://", "hy2://")
          for in_name, xray_name, hyst_name in [
              ("available", "available_xray", "available_hysteria"),
              ("white-list_available", "white-list_available_xray", "white-list_available_hysteria"),
          ]:
              in_path = Path("configs", in_name)
              xray_path = Path("configs", xray_name)
              hyst_path = Path("configs", hyst_name)
              xray_lines, hyst_lines = [], []
              with in_path.open(encoding="utf-8") as f:
                  for line in f:
                      s = line.strip()
                      if not s or s.startswith("#"):
                          continue
                      (hyst_lines if s.startswith(prefixes) else xray_lines).append(line)
              xray_path.write_text("".join(xray_lines), encoding="utf-8")
              hyst_path.write_text("".join(hyst_lines), encoding="utf-8")
              print(f"{in_name}: Xray {len(xray_lines)}, Hysteria {len(hyst_lines)}")
          PY

      - name: "Speedtest Xray: configs/available_xray"
        run: |
          if [ -s "configs/available_xray" ]; then
            python speedtest_checker.py configs/available_xray
          else
            echo "No Xray lines in available, skip"
          fi
        env:
          MAX_WORKERS: ${{ env.MAX_WORKERS }}
          BASE_PORT: ${{ env.BASE_PORT }}
          XRAY_STARTUP_WAIT: ${{ env.XRAY_STARTUP_WAIT }}
          XRAY_STARTUP_POLL_INTERVAL: ${{ env.XRAY_STARTUP_POLL_INTERVAL }}
          VERIFY_HTTPS_SSL: ${{ env.VERIFY_HTTPS_SSL }}
          SPEED_TEST_ENABLED: ${{ env.SPEED_TEST_ENABLED }}
          SPEED_TEST_TIMEOUT: ${{ env.SPEED_TEST_TIMEOUT }}
          SPEED_TEST_MODE: ${{ env.SPEED_TEST_MODE }}
          SPEED_TEST_METRIC: ${{ env.SPEED_TEST_METRIC }}
          SPEED_TEST_OUTPUT: ${{ env.SPEED_TEST_OUTPUT }}
          SPEED_TEST_REQUESTS: ${{ env.SPEED_TEST_REQUESTS }}
          SPEED_TEST_URL: ${{ env.SPEED_TEST_URL }}
          SPEED_TEST_WORKERS: ${{ env.SPEED_TEST_WORKERS }}
          SPEED_TEST_DOWNLOAD_TIMEOUT: ${{ env.SPEED_TEST_DOWNLOAD_TIMEOUT }}
          SPEED_TEST_DOWNLOAD_URL_SMALL: ${{ env.SPEED_TEST_DOWNLOAD_URL_SMALL }}
          SPEED_TEST_DOWNLOAD_URL_MEDIUM: ${{ env.SPEED_TEST_DOWNLOAD_URL_MEDIUM }}
          MIN_SPEED_THRESHOLD_MBPS: ${{ env.MIN_SPEED_THRESHOLD_MBPS }}
          SPEED_TEST_DEBUG: ${{ env.SPEED_TEST_DEBUG }}
          OUTPUT_DIR: ${{ env.OUTPUT_DIR }}

      - name: "Speedtest Hysteria: configs/available_hysteria"
        run: |
          if [ -s "configs/available_hysteria" ]; then
            python speedtest_hysteria.py configs/available_hysteria
          else
            touch configs/available_hysteria_st
          fi

      - name: "Merge available: Xray + Hysteria -> configs/available_st"
        run: |
          xray="configs/available_xray_st"
          hyst="configs/available_hysteria_st"
          out="configs/available_st"
          out100="configs/available_st(top100)"
          { [ -s "$xray" ] && cat "$xray"; [ -s "$hyst" ] && cat "$hyst"; } | grep -v '^$' > "$out" || true
          if [ -s "$out" ]; then head -n 100 "$out" > "$out100"; fi
          echo "available_st: $(wc -l < "$out" 2>/dev/null || echo 0) lines"

      - name: "Speedtest Xray: configs/white-list_available_xray"
        run: |
          if [ -s "configs/white-list_available_xray" ]; then
            python speedtest_checker.py configs/white-list_available_xray
          else
            echo "No Xray lines in white-list_available, skip"
          fi
        env:
          MAX_WORKERS: ${{ env.MAX_WORKERS }}
          BASE_PORT: ${{ env.BASE_PORT }}
          XRAY_STARTUP_WAIT: ${{ env.XRAY_STARTUP_WAIT }}
          XRAY_STARTUP_POLL_INTERVAL: ${{ env.XRAY_STARTUP_POLL_INTERVAL }}
          VERIFY_HTTPS_SSL: ${{ env.VERIFY_HTTPS_SSL }}
          SPEED_TEST_ENABLED: ${{ env.SPEED_TEST_ENABLED }}
          SPEED_TEST_TIMEOUT: ${{ env.SPEED_TEST_TIMEOUT }}
          SPEED_TEST_MODE: ${{ env.SPEED_TEST_MODE }}
          SPEED_TEST_METRIC: ${{ env.SPEED_TEST_METRIC }}
          SPEED_TEST_OUTPUT: ${{ env.SPEED_TEST_OUTPUT }}
          SPEED_TEST_REQUESTS: ${{ env.SPEED_TEST_REQUESTS }}
          SPEED_TEST_URL: ${{ env.SPEED_TEST_URL }}
          SPEED_TEST_WORKERS: ${{ env.SPEED_TEST_WORKERS }}
          SPEED_TEST_DOWNLOAD_TIMEOUT: ${{ env.SPEED_TEST_DOWNLOAD_TIMEOUT }}
          SPEED_TEST_DOWNLOAD_URL_SMALL: ${{ env.SPEED_TEST_DOWNLOAD_URL_SMALL }}
          SPEED_TEST_DOWNLOAD_URL_MEDIUM: ${{ env.SPEED_TEST_DOWNLOAD_URL_MEDIUM }}
          MIN_SPEED_THRESHOLD_MBPS: ${{ env.MIN_SPEED_THRESHOLD_MBPS }}
          SPEED_TEST_DEBUG: ${{ env.SPEED_TEST_DEBUG }}
          OUTPUT_DIR: ${{ env.OUTPUT_DIR }}

      - name: "Speedtest Hysteria: configs/white-list_available_hysteria"
        run: |
          if [ -s "configs/white-list_available_hysteria" ]; then
            python speedtest_hysteria.py configs/white-list_available_hysteria
          else
            touch configs/white-list_available_hysteria_st
          fi

      - name: "Merge white-list_available: Xray + Hysteria -> configs/white-list_available_st"
        run: |
          xray="configs/white-list_available_xray_st"
          hyst="configs/white-list_available_hysteria_st"
          out="configs/white-list_available_st"
          out100="configs/white-list_available_st(top100)"
          { [ -s "$xray" ] && cat "$xray"; [ -s "$hyst" ] && cat "$hyst"; } | grep -v '^$' > "$out" || true
          if [ -s "$out" ]; then head -n 100 "$out" > "$out100"; fi
          echo "white-list_available_st: $(wc -l < "$out" 2>/dev/null || echo 0) lines"

      - name: Normalize comments (strip + add flag and AUTO_COMMENT)
        if: env.AUTO_COMMENT != ''
        run: |
          for base in available_st "white-list_available_st"; do
            if [ -s "configs/$base" ]; then
              python strip_vpn_comments.py "configs/$base" -o "configs/$base"
              echo "Normalized configs/$base"
            fi
            if [ -s "configs/${base}(top100)" ]; then
              python strip_vpn_comments.py "configs/${base}(top100)" -o "configs/${base}(top100)"
              echo "Normalized configs/${base}(top100)"
            fi
          done
        env:
          AUTO_COMMENT: ${{ env.AUTO_COMMENT }}

      - name: Verify output and update last-updated.json
        run: |
          if [ ! -f "configs/available_st" ] && [ ! -f "configs/white-list_available_st" ]; then
            echo "::warning::Neither configs/available_st nor configs/white-list_available_st created (no successful results?), skip push"
            exit 0
          fi
          for base in available_st "white-list_available_st"; do
            if [ -f "configs/$base" ] && [ ! -f "configs/${base}(top100)" ]; then
              head -n 100 "configs/$base" > "configs/${base}(top100)"
            fi
          done
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          C_AV=$(wc -l < configs/available_st 2>/dev/null || echo 0)
          C_AV100=$(wc -l < "configs/available_st(top100)" 2>/dev/null || echo 0)
          C_WL=$(wc -l < configs/white-list_available_st 2>/dev/null || echo 0)
          C_WL100=$(wc -l < "configs/white-list_available_st(top100)" 2>/dev/null || echo 0)
          OLD=$(cat configs/last-updated.json 2>/dev/null || echo '{}')
          echo "$OLD" | jq -c --arg t "$NOW" \
            --argjson c_av "$C_AV" --argjson c_av100 "$C_AV100" \
            --argjson c_wl "$C_WL" --argjson c_wl100 "$C_WL100" \
            '.["configs/available_st"] = {updated: $t, count: $c_av} |
             .["configs/available_st(top100)"] = {updated: $t, count: $c_av100} |
             .["configs/white-list_available_st"] = {updated: $t, count: $c_wl} |
             .["configs/white-list_available_st(top100)"] = {updated: $t, count: $c_wl100}' \
            > configs/last-updated.json
          echo "Output:"
          ls -la configs/available_st "configs/available_st(top100)" configs/white-list_available_st "configs/white-list_available_st(top100)" 2>/dev/null || true

      - name: Commit and push speedtest results
        run: |
          if [ ! -f "configs/available_st" ] && [ ! -f "configs/white-list_available_st" ]; then
            echo "Nothing to commit (no successful speedtest results)."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          for f in configs/available_st "configs/available_st(top100)" configs/white-list_available_st "configs/white-list_available_st(top100)" configs/last-updated.json; do
            [ -f "$f" ] && git add "$f"
          done
          if ! git diff --cached --quiet; then
            git commit -m "update speedtest [automated]"
            git pull --rebase origin "${{ github.ref_name }}"
            git push
          else
            echo "Speedtest results unchanged, skip push"
          fi

      - name: Prepare Telegram stats
        id: telegram_stats
        run: |
          K_IN=0
          [ -f configs/available ] && K_IN=$((K_IN + $(wc -l < configs/available)))
          [ -f configs/white-list_available ] && K_IN=$((K_IN + $(wc -l < configs/white-list_available)))
          K_OUT=0
          [ -f configs/available_st ] && K_OUT=$((K_OUT + $(wc -l < configs/available_st)))
          [ -f configs/white-list_available_st ] && K_OUT=$((K_OUT + $(wc -l < configs/white-list_available_st)))
          END=$(date -u +%s)
          START=${{ steps.start.outputs.started_at }}
          DURATION_SEC=$(( END - START ))
          printf -v DURATION "%d:%02d" $(( DURATION_SEC / 60 )) $(( DURATION_SEC % 60 ))
          echo "workflow_name=Speedtest" >> $GITHUB_OUTPUT
          echo "keys_in=$K_IN" >> $GITHUB_OUTPUT
          echo "keys_out=$K_OUT" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

  notify-telegram:
    needs: speedtest-and-publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Send workflow stats to Telegram
        uses: ./.github/actions/telegram-workflow-stats
        with:
          workflow_name: ${{ needs.speedtest-and-publish.outputs.stats_workflow_name }}
          keys_in: ${{ needs.speedtest-and-publish.outputs.stats_keys_in }}
          keys_out: ${{ needs.speedtest-and-publish.outputs.stats_keys_out }}
          duration: ${{ needs.speedtest-and-publish.outputs.stats_duration }}
          bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          extra_section: |
            Обновлённые подписки:

            Available:
            [Available Speedtest](https://whiteprime.github.io/xraycheck/configs/available_st)
            [Available Speedtest (top100)](https://whiteprime.github.io/xraycheck/configs/available_st%28top100%29)

            White List:
            [White List Speedtest](https://whiteprime.github.io/xraycheck/configs/white-list_available_st)
            [White List Speedtest (top100)](https://whiteprime.github.io/xraycheck/configs/white-list_available_st%28top100%29)
